<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/favicon-180x180.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="canonical" href="https://dev.procoder.io/articles/medium/2022-06-15_unit-tests-saved-my-hide-and-helped-me-track-down-the-real-problem--bccd78f2021d/"><meta name="generator" content="Astro v5.7.9"><title>Unit tests saved my hide and helped me track down the REAL problem! | Pro Coder</title><!-- Google tag (gtag.js) @formatter:off --><script async src="https://www.googletagmanager.com/gtag/js?id=G-8W1YK6K7NM"></script> <script type="module">const a={measurementId:"G-8W1YK6K7NM"};window.dataLayer=window.dataLayer||[];window.gtag=function(){dataLayer.push(arguments)};window.gtag("js",new Date);window.gtag("config",a.measurementId);</script> <!-- Google tag (gtag.js) @formatter:on --><meta name="description" content="I recently picked up a curious ticket. Someone was using an obscure combination of features inside Spring Data JPA. In particular, DTO…"><meta name="robots" content="index, follow"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"><!-- Open Graph --><meta property="og:type" content="website"><meta property="og:url" content="https://dev.procoder.io/articles/medium/2022-06-15_unit-tests-saved-my-hide-and-helped-me-track-down-the-real-problem--bccd78f2021d/"><meta property="og:title" content="Unit tests saved my hide and helped me track down the REAL problem! | Pro Coder"><meta property="og:description" content="I recently picked up a curious ticket. Someone was using an obscure combination of features inside Spring Data JPA. In particular, DTO…"><meta property="og:image" content="https://dev.procoder.io/_astro/1_lBbkAlt-jJWnNGfvrfET6A.DATuZDn7.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://dev.procoder.io/articles/medium/2022-06-15_unit-tests-saved-my-hide-and-helped-me-track-down-the-real-problem--bccd78f2021d/"><meta property="twitter:title" content="Unit tests saved my hide and helped me track down the REAL problem! | Pro Coder"><meta property="twitter:description" content="I recently picked up a curious ticket. Someone was using an obscure combination of features inside Spring Data JPA. In particular, DTO…"><meta property="twitter:image" content="https://dev.procoder.io/_astro/1_lBbkAlt-jJWnNGfvrfET6A.DATuZDn7.png"><link rel="stylesheet" href="/_astro/_page_.qInwd9Ou.css"></head> <body data-theme="procoder"> <header class="fixed top-0 z-50 w-full left-0"> <div class="site-container mx-auto px-4 mt-4"> <div class="flex justify-between items-center gap-4 bg-primary/90 py-2 lg:py-4 rounded-lg px-4 border-black border"> <a href="/" class="logo uppercase font-logo transition-colors duration-200 font-light text-header-logo hover:text-primary">  <img src="/_astro/ProCoderLogo_white.DI51sbMv_Z1hejQB.webp" alt width="1800" height="1800" loading="lazy" decoding="async" class="w-16 h-auto">  </a> <nav class="relative flex items-center gap-2 lg:gap-8" aria-label="Site Navigation"> <!-- Desktop Menu --> <ul class="hidden lg:flex lg:gap-8 items-center"> <li class="relative group"> <div class="flex items-center gap-1"> <a href="/" class="text-small font-medium uppercase rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-nav-text-active text-nav-text hover:text-nav-text-hover"> Home  </a> </div>  </li><li class="relative group"> <div class="flex items-center gap-1"> <a href="/bio" class="text-small font-medium uppercase rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-nav-text-active text-nav-text hover:text-nav-text-hover"> About Greg  </a> </div>  </li><li class="relative group"> <div class="flex items-center gap-1"> <a href="https://procoder.myspreadshop.com" class="text-small font-medium uppercase rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-nav-text-active text-nav-text hover:text-nav-text-hover"> Merch  </a> </div>  </li> </ul> <!-- CartButton is after desktop menus, but before the hamburger icon --> <a href="/checkout" class="flex items-center gap-2 text-background px-4 py-2 transition " id="cart-button"> <div class="relative text-secondary"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="28" height="28" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" class="lucide lucide-shopping-cart">  <circle cx="8" cy="21" r="1"></circle> <circle cx="19" cy="21" r="1"></circle> <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>  </svg> <span id="cart-count" class="absolute top-[-5px] right-[-10px] bg-secondary text-background-dark text-xs rounded-full w-5 h-5 flex items-center justify-center">
0
</span> </div> <script type="module" src="/_astro/CartButton.astro_astro_type_script_index_0_lang.D-t14tcm.js"></script> </a> <!-- Mobile Menu Button --> <button class="mobile-menu-button relative z-30 p-2 border-none cursor-pointer bg-transparent lg:hidden" aria-label="Toggle Menu" aria-expanded="false"> <span class="menu-icon block"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="24" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" class="lucide lucide-menu text-nav-mobile-text">  <line x1="4" x2="20" y1="12" y2="12"></line> <line x1="4" x2="20" y1="6" y2="6"></line> <line x1="4" x2="20" y1="18" y2="18"></line>  </svg> </span> <span class="close-icon hidden"> <svg xmlns="http://www.w3.org/2000/svg" stroke-width="2" width="24" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" viewBox="0 0 24 24" class="lucide lucide-x text-nav-mobile-text">  <path d="M18 6 6 18"></path> <path d="m6 6 12 12"></path>  </svg> </span> </button> <!-- Mobile Menu Panel --> <div class="mobile-menu fixed inset-0 z-20 px-8 pt-20 bg-primary lg:hidden hidden opacity-0 scale-95 transform transition-all duration-200 ease-out overflow-y-auto"> <ul class="flex flex-col gap-4"> <li> <div class="text-headline-dark"> <div class="flex items-center justify-between"> <a href="/" class="py-1 rounded-md focus:outline-none focus:ring-2 focus:ring-nav-mobile-text-active text-nav-mobile-text hover:text-nav-mobile-text-hover"> Home </a>  </div>  </div> </li><li> <div class="text-headline-dark"> <div class="flex items-center justify-between"> <a href="/bio" class="py-1 rounded-md focus:outline-none focus:ring-2 focus:ring-nav-mobile-text-active text-nav-mobile-text hover:text-nav-mobile-text-hover"> About Greg </a>  </div>  </div> </li><li> <div class="text-headline-dark"> <div class="flex items-center justify-between"> <a href="https://procoder.myspreadshop.com" class="py-1 rounded-md focus:outline-none focus:ring-2 focus:ring-nav-mobile-text-active text-nav-mobile-text hover:text-nav-mobile-text-hover"> Merch </a>  </div>  </div> </li> </ul> </div> </nav> </div> </div> <script type="module">const v=document.querySelectorAll(".group");v.forEach(s=>{const e=s.querySelector("a"),t=s.querySelector(".submenu"),n=t?.querySelectorAll("a");t&&e&&(s.addEventListener("mouseenter",()=>{l(t,e)}),s.addEventListener("mouseleave",()=>{i(t,e)}),e.addEventListener("keydown",c=>{c.key==="ArrowDown"&&s.children&&(c.preventDefault(),l(t,e),n?.[0]?.focus())}),e.addEventListener("focus",()=>{i(t,e)}),n?.forEach((c,a)=>{c.addEventListener("keydown",d=>{const m=n.length-1;switch(d.key){case"ArrowDown":d.preventDefault(),a<m&&n[a+1].focus();break;case"ArrowUp":d.preventDefault(),a>0?n[a-1].focus():(e.focus(),i(t,e));break;case"Escape":d.preventDefault(),i(t,e),e.focus();break;case"Tab":i(t,e);break}})}),document.addEventListener("focusin",c=>{s&&!s.contains(c.target)&&i(t,e)}))});function l(s,e){s.classList.remove("invisible","opacity-0"),s.classList.add("visible","opacity-100"),e.setAttribute("aria-expanded","true")}function i(s,e){s.classList.add("invisible","opacity-0"),s.classList.remove("visible","opacity-100"),e.setAttribute("aria-expanded","false")}document.querySelectorAll(".mobile-submenu-button").forEach(s=>{s.addEventListener("click",()=>{const e=s.parentElement?.nextElementSibling,t=s.querySelector("svg");if(e){e.classList.toggle("hidden"),t?.classList.toggle("rotate-180");const n=e.classList.contains("hidden")?"false":"true";s.setAttribute("aria-expanded",n)}})});const f=document.querySelector(".mobile-menu-button"),o=document.querySelector(".mobile-menu"),r=document.querySelector(".menu-icon"),u=document.querySelector(".close-icon");f?.addEventListener("click",()=>{o?.classList.contains("hidden")?(document.body.style.overflow="hidden",o?.classList.remove("hidden"),requestAnimationFrame(()=>{o?.classList.remove("opacity-0","scale-95"),o?.classList.add("opacity-100","scale-100")}),r?.classList.add("hidden"),u?.classList.remove("hidden")):(document.body.style.overflow="",o?.classList.add("opacity-0","scale-95"),o?.classList.remove("opacity-100","scale-100"),setTimeout(()=>{o?.classList.add("hidden")},200),r?.classList.remove("hidden"),u?.classList.add("hidden"))});</script> </header>  <div class="w-full h-120 absolute top-0 left-0 z-0 overflow-hidden border-b border-black">  <img src="/_astro/1_lBbkAlt-jJWnNGfvrfET6A.DATuZDn7_Z1nOzow.webp" alt width="1920" height="1080" loading="lazy" decoding="async" class="w-full h-full object-cover grayscale opacity-20"> <div class="absolute inset-0 bg-primary/10 backdrop-blur-md"></div>  </div> <article class="site-container--small mx-auto px-4 prose relative z-10 pb-base"> <div class="mt-42 mb-12 text-center"> <h1>Unit tests saved my hide and helped me track down the REAL problem!</h1> <div class="flex items-center justify-center gap-4 text-gray-600"> <time datetime="2022-06-15T00:00:00.000Z" class="text-sm text-body-base"> June 15th, 2022 </time> <div class="flex flex-wrap gap-2"> <span class="px-2 py-1 text-sm rounded-sm bg-primary/10 text-primary border-primary border flex items-center justify-center leading-none font-medium"> Imported from Medium </span> </div> </div> </div> <img src="/_astro/1_lBbkAlt-jJWnNGfvrfET6A.DATuZDn7_cvOoe.webp" alt width="1200" height="675" loading="lazy" decoding="async" class="w-full h-auto rounded-lg border mb-12 border-black"> <div class="mt-8"> <h1 id="unit-tests-saved-my-hide-and-helped-me-track-down-the-real-problem">Unit tests saved my hide and helped me track down the REAL problem!</h1>
<p>I recently picked up a curious ticket. Someone was using an obscure combination of features inside Spring Data JPA. In particular, DTO…</p>
<hr>
<h3 id="unit-tests-saved-my-hide-and-helped-me-track-down-the-realproblem">Unit tests saved my hide and helped me track down the REAL problem!</h3>
<p>I recently picked up a curious ticket. Someone was using an obscure combination of features inside Spring Data JPA. In particular, DTO objects and paging.</p>
<p>Say what?</p>
<p>Did you know you can write JPQL statements like this?</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT new com.example.CustomDto(u.firstname, u.lastname) from User u</span></span></code></pre>
<p>What you’re doing is essentially pre-converting the results into this DTO type instead of the usual entity type. There are some key requirements like having to spell out the FQDN (fully qualified domain name), but other than, it makes for a tidy arrangement.</p>
<p>In Spring Data JPA, this can manifest as either a named query in the entity’s definition, or you can apply it through the @Query annotation on your repository!</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>@Query(SELECT new com.example.CustomDto(u.firstname, u.lastname) from User u")  </span></span>
<span class="line"><span>List&#x3C;CustomDto> findByNamedQueryWithConstructorExpression();</span></span></code></pre>
<p>Maybe that is a little clunky? If you’ve just recently picked up JPA and are using to writing bare SQL, this can look super cray. Nevertheless, it’s actually a feature I learned about recently that I think is handy if you’re wanting to keep the entity-to-DTO translation close to each other.</p>
<blockquote>
<p>BTW, IntelliJ IDEA totally can parse these strings! It even offers code completion. If you ever have doubts, put them aside. IntelliJ IDEA is always a step or two ahead of us, ready to do what’s key to maintaining code.</p>
</blockquote>
<p>So what’s the problem in all this?</p>
<p>When you take this seemingly harmless statement above and alter it’s signature to return a <strong>Page</strong> of <strong>CustomDto</strong> objects, you may or may not have everything fall apart.</p>
<p>No, this isn’t Schrödinger’s Bug (though it may feel like it!)</p>
<p>If you instead have THIS in your repository definition:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>@Query(SELECT new com.example.CustomDto(u.firstname, u.lastname) from User u")  </span></span>
<span class="line"><span>Page&#x3C;CustomDto> findByNamedQueryWithConstructorExpression(Pageable pageable);</span></span></code></pre>
<p>…then you are picking up Spring Data JPA’s ability to fetch a subset of results automatically. However, to do this, Spring Data JPA must first transform the query into a count-based query so it can, you know, count the results!</p>
<p>And that’s where a really quirky bug lives. Due to pattern matching rules written long ago, everything works great if this query has a DISTINCT. But if NOT, well, it blows up if there’s no comma anywhere inside that “new com.example.CustomDTO” expression.</p>
<p>BOTTOM LINE: Spring Data JPA can’t handle one of these DTO-oriented operations to fashion a Page <strong>if the DTO only has one argument</strong>.</p>
<p>Whew! That was, what’s the clinical term? Overcomplicated for describing a problem.</p>
<p>Suffice it to say, I spent all day JUST TRYING TO WRITE A TEST CASE. At first, I thought I had figured out the problem no longer existed. I was ready to commit my smug little tests, since there’s <a href="/articles/medium/2022-06-01_writing-tests-is-never-a-mistake--78d7054f56ba">nothing wrong with submitting a new test case even if no code has changed</a>.</p>
<p><img  width="800" height="468" loading="lazy" decoding="async" src="/_astro/1_lBbkAlt-jJWnNGfvrfET6A.DATuZDn7_Z2rsuFI.webp" >I thought the issue no longer existed!But something in the back of my mind wouldn’t accept that. No, I sensed that I should poke and prod some more. And that proved correct. My original test case did NOT properly apply the Paging situation.</p>
<p>Once I wiggled things into place, I sure enough had a failing test case right in front of my very eyes.</p>
<p><img  width="800" height="108" loading="lazy" decoding="async" src="/_astro/1_pN0gsTnXYKD3rKcVL_W5eQ.DEVoADiO_Z2fCCmo.webp" >But…I was wrong.With a nicely failing test case right in front of me, I could FINALLY engage with IntelliJ’s debugger. And boy howdy did I do that.</p>
<p>Something you may not know, is that Spring Data JPA does a lot of parsing upfront when you have repository definitions. What that means is that if you put a plain old breakpoint smack dab in the middle of its parsing algorithm, the debugger will stop FOR EVERY SINGLE REPOSITORY METHOD.</p>
<p>So I had to utilize conditional breakpoints. You just right-click on an existing break point and add a little pseudo-Java code to ONLY stop if the query string has my little <strong>CustomDto</strong> object in it.</p>
<p>I say pseudo-Java, because you not only have access to all in-scope methods, but IntelliJ seems to have some bean property shortcuts also at your beck and call.</p>
<p>Anywho, with conditional breakpoints in place, I started running the test cases relentless, until I narrowed everything down to a tiny sliver of code that used regular expressions to rip apart that query string and then wrap it with a nice <strong>count()</strong> operation.</p>
<p>And so I started down the regular expression logic and TRIED to figure out what it was doing. A day-and-a-half in, and I was looking at something I kinda sorta had a glimmer of an idea how it worked.</p>
<p><img  width="800" height="1067" loading="lazy" decoding="async" src="/_astro/1_OckUet1N5PyK6YkQhGhHhg.DPMvuD3w_Z1nrLJ.webp" >Me, trying to grok a regular expressionSuffice it to say, I tried this, that, and the other thing. And none of them worked. This little beasty of code kept tripping me up!</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>boolean useVariable = StringUtils.*hasText*(variable) *//* &#x26;&#x26; !variable.startsWith(" new") *//* &#x26;&#x26; !variable.startsWith("count(") *//* &#x26;&#x26; !variable.contains(",");</span></span></code></pre>
<p>This little fragment of code would end up as <strong>false</strong> for a 2-argument DTO (which worked) but <strong>true</strong> for a 1-argument DTO. It needed to be <strong>false</strong> for both!</p>
<p>So I subtly <em>overrode it with</em> <em><strong>false</strong></em> and then ran the entire test suite!</p>
<p>And what do you know! Almost everything PASSED.</p>
<p>Except for like TWO test cases. And they both had something to do with <strong>select distinct</strong>.</p>
<p>Now I had started at the tiny space right before new up in that code fragment more than once. Have you? Something weird about it? I had even tried removing the space. After all, isn’t that THE SAME THING?</p>
<p>Well, on a fluke, I decided to ADD another clause:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>&#x26;&#x26; !variable.startsWith("new")</span></span></code></pre>
<p>Same as the other one, but no spaces. I ran the battery of test cases. And they ALL worked.</p>
<p>And then I looked, dumbfounded and my jaw wide open, I saw it. I realized it.</p>
<p><strong>startsWith(“ new”)</strong> and <strong>startsWith(“new”)</strong> are absolutely, positively NOT THE SAME THING. I was imagining <strong>contains()</strong>. But <strong>startsWith()</strong> is VERY CLEARLY different.</p>
<p>With a “whoop de doo”, I proceeded to polish it all up, and ensure that the information just gleaned from an entire day’s effort would NOT be lost, turning out this little fragment of code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>boolean useVariable = StringUtils.*hasText*(variable) *//* &#x26;&#x26; !variable.startsWith("new") *// select [new com.example.User...* &#x26;&#x26; !variable.startsWith(" new") *// select distinct[ new com.example.User...* &#x26;&#x26; !variable.startsWith("count(") *// select [count(...* &#x26;&#x26; !variable.contains(",");</span></span></code></pre>
<p>The added comments were to help jog my own memory, in case we ran into this in the future.</p>
<p>I also was able to polish up test cases, ensuring we were testing every angle.</p>
<p>And once again, regular expressions turned out to <a href="/articles/medium/2022-06-08_how-i-stopped-worrying-and-learned-to-love-regular-expressions-40fd12400bf0">not be as tragic as they could have</a>! After making sure everything was up to Spring standards, I proceeded to backport the fix to all supported versions.</p>
<p>That last backport took a little extra finessing, but it was worth it. And nothing puts a smile more than seeing an emoji reaction on my final summary comment:</p>
<p><img  width="800" height="220" loading="lazy" decoding="async" src="/_astro/1_YDmivymH4vZyCR_hBM-7kA.DpFkrdnN_tWYHw.webp" >Emojis in GitHub are always welcome! Makes the whole effort worth it.If you are monitoring a ticket and have the chance to “thumbs up” or cheer someone’s effort, please do. It’s one of those tiny opportunities we all have to spread a little cheer.</p>
<p>Stay tuned for my next article. However, if you simply can’t wait, then check out the video below where I find the most powerful coder in all of gamingland to help me write a web app!</p>
<p>— Greg</p>
<p><em>Do you want to get a free tech e-book, be alerted to my discounts, and get even MORE content about SPRING BOOT? Then</em> <a href="https://trnq.st/d2v5"><em>SIGN UP FOR MY NEWSLETTER</em></a><em>.</em></p> </div> <h6>
Originally published as <i><a rel="canonical" target="_blank" href="https://medium.com/@procoderio/unit-tests-saved-my-hide-and-helped-me-track-down-the-real-problem-bccd78f2021d">Unit tests saved my hide and helped me track down the REAL problem!</a></i> </h6> </article>   <footer class="bg-background-dark text-body-dark text-small pb-small pt-4"> <div class="site-container mx-auto px-4"> <div class="flex flex-col items-center md:items-start md:flex-row md:justify-between pb-8 border-b border-background-light"> <nav class="flex flex-row justify-center md:justify-start gap-4 md:gap-8"> <div> <a href="/" class="text-small font-medium text-body-dark uppercase focus:outline-none focus:ring-2 focus:ring-nav-text-active transition-colors text-nav-text hover:text-nav-text-hover"> Home </a> </div><div> <a href="/whitelist-instructions" class="text-small font-medium text-body-dark uppercase focus:outline-none focus:ring-2 focus:ring-nav-text-active transition-colors text-nav-text hover:text-nav-text-hover"> Whitelist Instructions </a> </div> </nav> </div> <div class="mt-8 flex flex-col md:flex-row justify-between items-center"> <div class="text-sm text-secondary"> <p class="mt-4">Actionable Advice to Advance Your Career</p>
© 2025 Greg L. Turnquist. All rights reserved.
</div> <nav class="mt-4 md:mt-0"> <ul class="flex flex-wrap gap-6"> <li> <a href="/legal/privacy-policy" class="text-sm text-secondary"> Privacy Policy </a> </li><li> <a href="/legal/terms-of-service" class="text-sm text-secondary"> Terms of Service </a> </li> </ul> </nav> </div> </div> </footer> <!--<ThemeSwitcher />--> <script type="module" src="/_astro/Layout.astro_astro_type_script_index_0_lang.DLBBgGU8.js"></script> </body> </html>